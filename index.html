<!DOCTYPE html>
<html>
<title>Sentence Generator</title>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.14.1/build/cssreset/cssreset-min.css">
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.3.0/pure-min.css">
<script src="http://yui.yahooapis.com/3.14.1/build/yui/yui-min.js"></script>
<style>
    .icon-drag{
        width:15px;
        height:15px;
        vertical-align:middle;
        margin:0px 2px 0px; 2px;
        display:inline-block;
        border-radius:2px;   
        background-color:grey;
    }
    
    .temp-area{
        background-color: rgba(0, 0, 0, 0.2);
    }
    
    .entity-color {
        background-color:rgb(223, 117, 20);
        color:white;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
    }
    
    .relation-color{
        background-color:rgb(28, 184, 65);
        color:white;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
    }
    
    .icon-duplicate{
        width:32px;
        height:32px;
        vertical-align:middle;
        margin-right:10px;
        display:inline-block;
        background-image:url(images/icon_copy.png);
    }
    
    .icon-delete{
        width:24px;
        height:24px;
        margin-left:5px;
        vertical-align:middle;
        display:inline-block;
        background-image:url(images/trash.png);
    
    }
        
    .dd-list {      
        display:inline-block;
        background-color:
        border: 1px solid black;
        background-color: #8DD5E7;
        padding:15px;
        cursor: move;
        border-radius:2px;
        letter-spacing:normal;
    }
    
    
    
    .dd-list.relation-tag{
        background-color:rgb(28, 184, 65);
        color: white;
        border: solid white 2px;
        border-radius: 4px;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
    }
    
    .dd-list.entity-tag{
        background-color:rgb(223, 117, 20); /* this is an orange */
        color: white;
        border: solid white 2px;
        border-radius: 4px;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        
    
    }
    
    .expression-list ul{
        letter-spacing:-0.4em;
    }
    
    /*menu setting*/  
    .ontology-list ul{
        letter-spacing:-0.3em;  
        margin:0px;
        background: #efefef; 
	   
    }
    
    .ontology-list ul a:hover{
        background: #4b545f;
		background: linear-gradient(top, #4f5964 0%, #5f6975 40%);
		background: -moz-linear-gradient(top, #4f5964 0%, #5f6975 40%);
		background: -webkit-linear-gradient(top, #4f5964 0%,#5f6975 40%);
        color:#fff;
    }
    
    
    /*submenu setting*/    
    .ontology-list-submenu{
        display:none;
        
    }
    
    
    .ontology-list li:hover ul {
        display: block;
        padding:30px;
        position: absolute;
  
    }
    
     /*all menu inner elements*/
     .ontology-list li{
        display:inline-block;
        zoom:1;
        *display:inline;
        
    }
    
    .ontology-list li a{
        display:inline-block;
        zoom:1;
        *display:inline;
        letter-spacing:normal;
        padding:10px;
        color: #757575; 
        text-decoration: none;
        border:1px solid white;
    }
    
    
     .pure-button-success,
        .pure-button-error,
        .pure-button-warning,
        .pure-button-secondary {
            color: white;
            border-radius: 4px;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        }

        .pure-button-success {
            background: rgb(28, 184, 65); /* this is a green */
        }

        .pure-button-error {
            background: rgb(202, 60, 60); /* this is a maroon */
        }

        .pure-button-warning {
            background: rgb(223, 117, 20); /* this is an orange */
        }

        .pure-button-secondary {
            background: rgb(66, 184, 221); /* this is a light blue */
        }
        
    .hidden{    
        display:none;
    }
    
    .for-copy{
        display:none;
    }
</style>

<body>
    <form class="pure-form">

        <fieldset>
            <legend>Application Information</legend>
            <input class="app-name" type="text" placeholder="Application Name">
            <input class="app-topic" type="text" placeholder="Topic">
        </fieldset>

        <fieldset class="ontology-graph">
            <legend>Ontology Graph with Interlingual Relation</legend>
            <div class="ontology-list">
                <ul>
                    <li>
                        <a href="#">Entity1</a>
                        <ul class="ontology-list-submenu">
                            <li>
                                <a href="#">People1</a>
                            </li>
                            <li>
                                <a href="#">Event1</a>
                            </li>
                            <li>
                                <a href="#">Time1</a>
                            </li>
                            <li>
                                <a href="#">Place1</a>
                            </li>
                            <li>
                                <a href="#">Object1</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="#">Relation</a>
                        <ul class="ontology-list-submenu">
                            <li>
                                <a href="#">IsA</a>
                            </li>
                            <li>
                                <a href="#">LocatedNear</a>
                            </li>
                            <li>
                                <a href="#">UsedFor</a>
                            </li>
                            <li>
                                <a href="#">DeﬁnedAs</a>
                            </li>
                            <li>
                                <a href="#">HasA</a>
                            </li>
                            <li>
                                <a href="#">SymbolOf</a>
                            </li>
                            <li>
                                <a href="#">CapableOf</a>
                            </li>
                            <li>
                                <a href="#">ReceivesAction</a>
                            </li>
                            <li>
                                <a href="#">Desires</a>
                            </li>
                            <li>
                                <a href="#">CreatedBy</a>
                            </li>
                            <li>
                                <a href="#">PartOf</a>
                            </li>
                            <li>
                                <a href="#">Causes</a>
                            </li>
                            <li>
                                <a href="#">HasFirstSubevent</a>
                            </li>
                            <li>
                                <a href="#">AtLocation</a>
                            </li>
                            <li>
                                <a href="#">HasProperty</a>
                            </li>
                            <li>
                                <a href="#">HasPrerequisite</a>
                            </li>
                            <li>
                                <a href="#">MotivatedByGoal</a>
                            </li>
                            <li>
                                <a href="#">CausesDesire</a>
                            </li>
                            <li>
                                <a href="#">MadeOf</a>
                            </li>
                            <li>
                                <a href="#">HasSubevent</a>
                            </li>
                            <li>
                                <a href="#">HasLastSubevent</a>
                            </li>
                            <li>
                                <a href="#">Action</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="#">Entity2</a>
                        <ul class="ontology-list-submenu">
                            <li>
                                <a href="#">People2</a>
                            </li>
                            <li>
                                <a href="#">Event2</a>
                            </li>
                            <li>
                                <a href="#">Time2</a>
                            </li>
                            <li>
                                <a href="#">Place2</a>
                            </li>
                            <li>
                                <a href="#">Object2</a>
                            </li>
                            <li>
                                <a href="#">None</a>
                            </li>

                        </ul>
                    </li>
                    <li>
                        <a href="#">Relation(Optional)</a>
                        <ul class="ontology-list-submenu">
                            <li>
                                <a href="#">IsA</a>
                            </li>
                            <li>
                                <a href="#">LocatedNear</a>
                            </li>
                            <li>
                                <a href="#">UsedFor</a>
                            </li>
                            <li>
                                <a href="#">DeﬁnedAs</a>
                            </li>
                            <li>
                                <a href="#">HasA</a>
                            </li>
                            <li>
                                <a href="#">SymbolOf</a>
                            </li>
                            <li>
                                <a href="#">CapableOf</a>
                            </li>
                            <li>
                                <a href="#">ReceivesAction</a>
                            </li>
                            <li>
                                <a href="#">Desires</a>
                            </li>
                            <li>
                                <a href="#">CreatedBy</a>
                            </li>
                            <li>
                                <a href="#">PartOf</a>
                            </li>
                            <li>
                                <a href="#">Causes</a>
                            </li>
                            <li>
                                <a href="#">HasFirstSubevent</a>
                            </li>
                            <li>
                                <a href="#">AtLocation</a>
                            </li>
                            <li>
                                <a href="#">HasProperty</a>
                            </li>
                            <li>
                                <a href="#">HasPrerequisite</a>
                            </li>
                            <li>
                                <a href="#">MotivatedByGoal</a>
                            </li>
                            <li>
                                <a href="#">CausesDesire</a>
                            </li>
                            <li>
                                <a href="#">MadeOf</a>
                            </li>
                            <li>
                                <a href="#">HasSubevent</a>
                            </li>
                            <li>
                                <a href="#">HasLastSubevent</a>
                            </li>
                            <li>
                                <a href="#">Action</a>
                            </li>
                            <li>
                                <a href="#">None</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="#">Entity3(Optional)</a>
                        <ul class="ontology-list-submenu">
                            <li>
                                <a href="#">People3</a>
                            </li>
                            <li>
                                <a href="#">Event3</a>
                            </li>
                            <li>
                                <a href="#">Time3</a>
                            </li>
                            <li>
                                <a href="#">Place3</a>
                            </li>
                            <li>
                                <a href="#">Object3</a>
                            </li>
                            <li>
                                <a href="#">None</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="sub-ontology-list pure-menu-horizontal">
                <ul>
                    <li>
                        <input class="entity" type="text" placeholder="Sub Entity1(Optional)">
                    </li>
                    <li>

                        <input class="relation" type="text" placeholder="Sub Relation(Optional)">
                    </li>
                    <li>

                        <input class="entity" type="text" placeholder="Sub Entity2(Optional)">
                    </li>
                    <li>

                        <input class="relation" type="text" placeholder="Sub Relation(Optional)">
                    </li>

                    <li>

                        <input class="entity" type="text" placeholder="Sub Entity3(Optional)">
                    </li>
                </ul>
            </div>
            <div class="sub-sub-ontology-list pure-menu-horizontal">
                <ul>
                    <li>
                        <input class="entity" type="text" placeholder="Sub sub Entity1(Optional)">
                    </li>
                    <li>

                        <input class="relation" type="text" placeholder="Sub sub Relation(Optional)">
                    </li>
                    <li>

                        <input class="entity" type="text" placeholder="Sub sub Entity2(Optional)">
                    </li>
                    <li>

                        <input class="relation" type="text" placeholder="Sub sub Relation(Optional)">
                    </li>

                    <li>

                        <input class="entity" type="text" placeholder="Sub sub Entity3(Optional)">
                    </li>
                </ul>
            </div>
        </fieldset>
    </form>
    <form class="pure-form">
        <fieldset>
            <legend>Instance</legend>
            <div class="instance-list pure-menu-horizontal">

                <ul class="instance-item for-copy">

                    <li>
                        <i class="icon-drag entity-color"></i>
                        <input class="entity" type="text" placeholder="Entity1">
                    </li>
                    <li>
                        <i class="icon-drag relation-color"></i>
                        <input class="relation" type="text" placeholder="Relation">
                    </li>
                    <li>
                        <i class="icon-drag entity-color"></i>
                        <input class="entity" type="text" placeholder="Entity2">
                    </li>
                    <li>
                        <i class="icon-drag relation-color"></i>
                        <input class="relation" type="text" placeholder="Relation(Optional)">
                    </li>

                    <li>
                        <i class="icon-drag entity-color"></i>
                        <input class="entity" type="text" placeholder="Entity3(Optional)">
                    </li>
                    <li class="icon-delete"></li>
                </ul>


                <ul class="instance-item">

                    <li>
                        <i class="icon-drag entity-color"></i>
                        <input class="entity" type="text" placeholder="Entity1">
                    </li>
                    <li>
                        <i class="icon-drag relation-color"></i>
                        <input class="relation" type="text" placeholder="Relation">
                    </li>
                    <li>
                        <i class="icon-drag entity-color"></i>
                        <input class="entity" type="text" placeholder="Entity2">
                    </li>
                    <li>
                        <i class="icon-drag relation-color"></i>
                        <input class="relation" type="text" placeholder="Relation(Optional)">
                    </li>

                    <li>
                        <i class="icon-drag entity-color"></i>
                        <input class="entity" type="text" placeholder="Entity3(Optional)">
                    </li>
                    <li class="icon-delete"></li>
                </ul>
            </div>

        </fieldset>
    </form>
    <button class="addInstance pure-button pure-button-primary">Add more instances</button>

    <form class="pure-form">
        <fieldset>
            <legend>Expression</legend>
            <div class="expression-list">

                <ul class="expression-item for-copy">
                    <li class="icon-duplicate"></li>
                    <li class="icon-drag"></li>
                    <li class="dd-list">
                        <input class="expression-text" type="text" placeholder="text(Optional)">
                    </li>

                    <li class="dd-list">
                        <input class="expression-text" type="text" placeholder="text(Optional)">
                    </li>

                    <li class="dd-list">
                        <input class="expression-text" type="text" placeholder="text(Optional)">
                    </li>

                    <li class="dd-list">
                        <input class="expression-text" type="text" placeholder="text(Optional)">
                    </li>

                    <li class="icon-delete"></li>
                    <li class="hidden">the-end</li>
                </ul>

                <ul class="expression-item">
                    <li class="icon-duplicate"></li>
                    <li class="icon-drag"></li>
                    <li class="dd-list">
                        <input class="expression-text" type="text" placeholder="text(Optional)">
                    </li>

                    <li class="dd-list">
                        <input class="expression-text" type="text" placeholder="text(Optional)">
                    </li>

                    <li class="dd-list">
                        <input class="expression-text" type="text" placeholder="text(Optional)">
                    </li>

                    <li class="dd-list">
                        <input class="expression-text" type="text" placeholder="text(Optional)">
                    </li>
                    <li class="icon-delete"></li>
                    <li class="hidden">the-end</li>

                </ul>
                <ul class="defined-entities-list temp-area">

                </ul>
                <ul class="defined-relations-list temp-area">

                </ul>
            </div>


        </fieldset>
    </form>
    <button class="getDefinedEntities pure-button pure-button-warning">Get Defined Entities</button>
    <button class="getDefinedRelations pure-button pure-button-success">Get Defined Relations</button>

    <button class="addExpression pure-button pure-button-primary">Add more expressions</button>
    <br>
    <br>
    <br>

    <form class="pure-form">
        <fieldset>
            <legend>Generate XML</legend>
        </fieldset>
    </form>
    <button class="genXML pure-button pure-button-primary">GenXML</button>

    <br>
    <br>
    <br>

    <form class="pure-form">
        <fieldset>
            <legend>Import HTML</legend>
        </fieldset>
    </form>
    <button class="importHTML pure-button pure-button-primary">Import HTML</button>

    <div class="storage-list">

    </div>

    <textarea id="output">
        <intent>
            <value>Question_People_LocationAt_Place</value>
            <topic>Question_People_LocationAt_Place</topic>
            <application>Jayden</application>
            <example>*</example>
            <variables>
                <item>
                    <name>People_index0</name>
                    <source>text</source>
                    <type>String</type>
                    <value>蘋果|香蕉</value>
                </item>
                <item>
                    <name>Place</name>
                    <source>text</source>
                    <type>String</type>
                    <value>紅冬冬的</value>
                </item>
            </variables>

            <regex>
                <expression>($adj$)($noun$)</expression>
                <expression>($adj$)($is$)($noun$)</expression>
            </regex>
        </intent>

    </textarea>

</body>
<script>
    YUI().use('datatype-xml', 'node', 'node-event-delegate', 'autocomplete', 'autocomplete-filters', 'autocomplete-highlighters', 'dd-drop-plugin', 'dd-constrain', 'dd-proxy', 'dd-drop', function(Y) {

        //autocomplete thing
        var entityDefined = [],
            relationDefined = [],
            allDefined = [],
            goingUp = false,
            lastX = 0,
            bindOntologySelection = function() {

                Y.all('.ontology-list-submenu a').on('click', function(evt) {
                    console.log(evt.currentTarget.ancestor().ancestor().ancestor().previous());
                    evt.currentTarget.ancestor().ancestor().previous().set('text', evt.currentTarget.get('text'));

                });

            },
            bindAutoComplete = function() {

                Y.all('.entity').plug(Y.Plugin.AutoComplete, {
                    resultHighlighter: 'phraseMatch',
                    resultFilters: 'phraseMatch',
                    source: entityDefined
                });

                Y.all('.relation').plug(Y.Plugin.AutoComplete, {
                    resultHighlighter: 'phraseMatch',
                    resultFilters: 'phraseMatch',
                    source: relationDefined
                });

                Y.all('.expression-text').plug(Y.Plugin.AutoComplete, {
                    resultHighlighter: 'phraseMatch',
                    resultFilters: 'phraseMatch',
                    source: allDefined
                });
            },
            bindDnD = function() {

                Y.DD.DDM.on('drop:over', function(e) {
                    //Get a reference to our drag and drop nodes
                    var drag = e.drag.get('node'),
                        drop = e.drop.get('node'),
                        isDDList = drag.getAttribute('class').indexOf('dd-list'),
                        isInsertSpace = drop.getAttribute('class').indexOf('insert-space');

                    //Are we dropping on a li node?
                    if (drop.get('tagName').toLowerCase() === 'li') {
                        //Are we not going up?
                        if (!goingUp) {
                            drop = drop.get('nextSibling');
                        }
                        //Add the node to this list
                        if (isDDList !== -1) {
                            drop.get('parentNode').insertBefore(drag, drop);
                        }

                        e.drop.sizeShim();
                    }
                });
                //Listen for all drag:drag events
                Y.DD.DDM.on('drag:drag', function(e) {
                    //Get the last y point
                    var x = e.target.lastXY[0];
                    //is it greater than the lastY var?
                    if (x < lastX) {
                        //We are going up
                        goingUp = true;
                    } else {
                        //We are going down.
                        goingUp = false;
                    }
                    //Cache for next check
                    lastX = x;
                });
                //Listen for all drag:start events
                Y.DD.DDM.on('drag:start', function(e) {
                    //Get our drag object
                    var drag = e.target;
                    //Set some styles here
                    drag.get('node').setStyle('opacity', '.25');

                });
                //Listen for a drag:end events
                Y.DD.DDM.on('drag:end', function(e) {
                    var drag = e.target;
                    //Put our styles back
                    drag.get('node').setStyles({
                        visibility: '',
                        opacity: '1'
                    });


                });
                //Listen for all drag:drophit events
                Y.DD.DDM.on('drag:drophit', function(e) {
                    var drop = e.drop.get('node'),
                        drag = e.drag.get('node'),
                        isDDList = e.drag.get('node').getAttribute('class').indexOf('dd-list');

                    //if we are not on an li, we must have been dropped on a ul
                    if (drop.get('tagName').toLowerCase() !== 'li') {
                        if (drop.contains(drag) !== true && isDDList !== -1) {
                            drop.appendChild(drag);
                        }
                    }
                });

                //Get the list of li's in the lists and make them draggable
                var lis = Y.Node.all('.expression-list ul li');
                lis.each(function(v, k) {
                    var dd = new Y.DD.Drag({
                        node: v,
                        target: {
                            padding: '0 0 0 20'
                        }
                    }).plug(Y.Plugin.DDProxy, {
                        moveOnEnd: false,
                        cloneNode: true
                    }).plug(Y.Plugin.DDConstrained, {
                        constrain2node: '.expression-list'
                    });

                });

                //Create simple targets for the 2 lists.
                var uls = Y.Node.all('.expression-list ul');
                uls.each(function(v, k) {
                    var tar = new Y.DD.Drop({
                        node: v
                    });
                });

            },
            bindDBLDelete = function(targetNode, currentTargetSelector) {
                targetNode.delegate('dblclick', function(evt) {
                    evt.currentTarget.addClass('hidden');
                    evt.currentTarget.empty();
                    console.log(evt.currentTarget);
                }, currentTargetSelector);
            },
            bindDDlist = function(rowOfDDlist) {
                var lis = rowOfDDlist.all('li').each(function(v, k) {
                    var dd = new Y.DD.Drag({
                        node: v,
                        target: {
                            padding: '0 0 0 20'
                        }
                    }).plug(Y.Plugin.DDProxy, {
                        moveOnEnd: false,
                        cloneNode: true
                    }).plug(Y.Plugin.DDConstrained, {
                        constrain2node: '.expression-list'
                    });

                }),
                    tar = new Y.DD.Drop({
                        node: rowOfDDlist
                    });


            },
            bindDuplicateButtons = function() {
                //duplicate
                Y.one('.expression-list').delegate('click', function(evt) {
                    var duplicateRow = evt.currentTarget.ancestor(),
                        cloneRow = duplicateRow.cloneNode(true),
                        lis;
                    duplicateRow.insert(cloneRow, "after");
                    //bind delete event
                    bindDBLDelete(cloneRow, '.dd-list');
                    //bind dd-list
                    bindDDlist(cloneRow);

                }, '.icon-duplicate');

            },
            bindTrashButtons = function() {
                //trash
                Y.one('.expression-list').delegate('dblclick', function(evt) {

                    var deleteRow = evt.currentTarget.ancestor();
                    deleteRow.addClass('hidden');


                }, '.icon-delete');

                Y.one('.instance-list').delegate('dblclick', function(evt) {

                    var deleteRow = evt.currentTarget.ancestor();
                    deleteRow.all('.entity').each(function(v, k) {

                        var index = entityDefined.indexOf(v.get('value'));
                        if (index > -1) {
                            entityDefined.splice(index, 1);
                        }
                    });
                    deleteRow.all('.relation').each(function(v, k) {
                        var index = relationDefined.indexOf(v.get('value'));
                        if (index > -1) {
                            relationDefined.splice(index, 1);
                        }

                    });

                    deleteRow.addClass('hidden');

                }, '.icon-delete');

            },
            bindRealtimeSaveEntityAndRelation = function() {
                //save entity and relation to defined
                Y.one('.instance-list').delegate('focus', function() {
                    var index = entityDefined.indexOf(this.get('value'));
                    if (index > -1) {
                        entityDefined.splice(index, 1);
                    }
                }, '.entity');

                Y.one('.instance-list').delegate('blur', function() {
                    var val = this.get('value'),
                        index = entityDefined.indexOf(val);
                    if (index === -1 && val !== "") {
                        entityDefined.push(val);
                        allDefined = entityDefined.concat(relationDefined);
                    }
                }, '.entity');


                Y.one('.instance-list').delegate('focus', function() {
                    var index = relationDefined.indexOf(this.get('value'));
                    if (index > -1) {
                        relationDefined.splice(index, 1);
                    }
                }, '.relation');


                Y.one('.instance-list').delegate('blur', function() {
                    var val = this.get('value'),
                        index = relationDefined.indexOf(val);
                    if (index === -1 && val !== "") {
                        relationDefined.push(val);
                        allDefined = entityDefined.concat(relationDefined);
                    }
                }, '.relation');


            },
            errorHandler = function(e) {
                var msg = '';

                switch (e.code) {
                    case FileError.QUOTA_EXCEEDED_ERR:
                        msg = 'QUOTA_EXCEEDED_ERR';
                        break;
                    case FileError.NOT_FOUND_ERR:
                        msg = 'NOT_FOUND_ERR';
                        break;
                    case FileError.SECURITY_ERR:
                        msg = 'SECURITY_ERR';
                        break;
                    case FileError.INVALID_MODIFICATION_ERR:
                        msg = 'INVALID_MODIFICATION_ERR';
                        break;
                    case FileError.INVALID_STATE_ERR:
                        msg = 'INVALID_STATE_ERR';
                        break;
                    default:
                        msg = 'Unknown Error';
                        break;
                };

                console.log('Error: ' + msg);
            };
        //bind ontology selection
        bindOntologySelection();

        //bind autocomplete
        bindAutoComplete();

        //dbl delete
        bindDBLDelete(Y.all('.expression-item').pop(), '.dd-list');

        //duplicate
        bindDuplicateButtons();

        //trash
        bindTrashButtons();

        //save entity and relation to defined
        bindRealtimeSaveEntityAndRelation();
        
        //bind DnD
        bindDnD();

        //add instance
        Y.one('.addInstance').on('click', function(evt) {
            evt.preventDefault();
            evt.stopPropagation();

            var instancelist = Y.one('.instance-list'),
                instancelistChild = Y.one('.instance-list ul').cloneNode(true).removeClass('for-copy');
            instancelist.appendChild(instancelistChild);
            console.log(Y.all('.instance-list ul').item(0));
            bindAutoComplete();

        });


        //add expression
        Y.one('.addExpression').on('click', function(evt) {
            evt.preventDefault();
            evt.stopPropagation();
            var expressionlist = Y.one('.expression-list'),
                expressionlistChild = Y.one('.expression-list ul').cloneNode(true).removeClass('for-copy');

            expressionlist.appendChild(expressionlistChild);
            bindDDlist(expressionlistChild);
            bindDBLDelete(Y.all('.expression-item').pop(), '.dd-list');

        });

        //get tags
        Y.one('.getDefinedEntities').on('click', function(evt) {
            evt.preventDefault();
            evt.stopPropagation();
            var expressionlist = Y.one('.expression-list'),
                definedEntitiesNode = Y.one('.defined-entities-list');

            expressionlist.appendChild(definedEntitiesNode);
            definedEntitiesNode.get('childNodes').remove();

            for (var i = 0; i < entityDefined.length; i++) {
                definedEntitiesNode.appendChild(Y.Node.create('<li class="dd-list entity-tag">' + entityDefined[i] + '</li>'));
            }

            bindDDlist(definedEntitiesNode);
            console.log('getDefinedEntities');


        });

        Y.one('.getDefinedRelations').on('click', function(evt) {
            evt.preventDefault();
            evt.stopPropagation();
            var expressionlist = Y.one('.expression-list'),
                definedRelationNode = Y.one('.defined-relations-list'),
                lis,
                uls;
            expressionlist.appendChild(definedRelationNode);
            definedRelationNode.get('childNodes').remove();

            for (var i = 0; i < relationDefined.length; i++) {
                definedRelationNode.appendChild(Y.Node.create('<li class="dd-list relation-tag">' + relationDefined[i] + '</li>'));
            }

            bindDDlist(definedRelationNode);
            console.log('getDefinedRelations');



        });




        /////////////////////
        ////output xml file
        /////////////////////
        Y.one('.genXML').on('click', function() {
            var inputXML = Y.one("#output").get("value"),
                outputXML = Y.XML.parse(inputXML);
            //outputXML.getElementsByTagName('name')[0].textContent = "";
            //console.log('gen!' + outputXML.getElementsByTagName('name')[0].textContent);

            var ontologyGraph = [],
                ontologyItems = Y.Node.all('.ontology-list >ul >li > a'),
                ontologyList = [],
                subontologyItems = Y.Node.all('.sub-ontology-list >ul >li > input'),
                subontologyList = [],
                subsubontologyItems = Y.Node.all('.sub-sub-ontology-list >ul >li > input'),
                subsubontologyList = [],
                instanceItems = Y.Node.all('.instance-list >ul >li > input'),
                instanceListForValueField = [],
                instanceListForNameField = [],
                expressionItems = Y.Node.all('.expression-item >li'),
                expressionList = [],
                isNan = function(val) {
                    if (val.indexOf('Optional') !== -1 || val.indexOf('None') !== -1 || val.indexOf('Relation') !== -1 || val.indexOf('Entity') !== -1 || val === "") {

                        return true;
                    } else {
                        return false;
                    }


                };
            // console.log(ontologyItems[0]);

            //ontology graph
            ontologyItems.each(function(v, k) {
                var val = v.get('innerHTML');
                if (!isNan(val)) {
                    ontologyList.push(val);
                    //console.log(v.get('innerHTML'));
                } else {
                    ontologyList.push("");
                }

            });

            subontologyItems.each(function(v, k) {
                var val = v.get('value');
                if (!isNan(val)) {
                    subontologyList.push(val);
                    //console.log(v.get('innerHTML'));
                } else {
                    subontologyList.push("");
                }

            });

            subsubontologyItems.each(function(v, k) {
                var val = v.get('value');
                if (!isNan(val)) {
                    subsubontologyList.push(val);
                    //console.log(v.get('innerHTML'));
                } else {
                    subsubontologyList.push("");
                }

            });

            for (var i = 0; i < ontologyList.length; i++) {
                var tempOntologyList = typeof ontologyList[i] === 'undefined' ? "" : ontologyList[i],
                    tempSubontologyList = typeof subontologyList[i] === 'undefined' ? "" : subontologyList[i],
                    tempSubsubontologyList = typeof subsubontologyList[i] === 'undefined' ? "" : subsubontologyList[i],
                    temp = tempOntologyList + "_" + tempSubontologyList + "_" + tempSubsubontologyList + "&";

                //var temp = ontologyList[i]+"_"+subontologyList[i]+"_"+subsubontologyList[i];
                ontologyGraph.push(temp);
                console.log(temp);

            }

            //instanceList
            instanceItems.each(function(v, k) {
                var val = v.get('value'),
                    currentIndex, //sentenceIndex
                    indexFromDefined,
                    sycIndex; //the index sync with ontologyList

                if (entityDefined.indexOf(val) === -1) {
                    indexFromDefined = "Relation_" + relationDefined.indexOf(val);
                } else {
                    indexFromDefined = "Entity_" + entityDefined.indexOf(val);
                }

                if (!isNan(val)) {
                    instanceListForValueField.push(val);
                    currentIndex = instanceListForValueField.length - 1;
                    sycIndex = (instanceListForValueField.length - 1) % (ontologyList.length - 1);

                    instanceListForNameField.push('Onto' + currentIndex + '_' + ontologyList[sycIndex] + '_' + indexFromDefined);
                    console.log('Onto' + currentIndex + '_' + ontologyList[sycIndex] + '_' + indexFromDefined);
                }

            });


            //expressionList
            var expresstionTemp = "";
            expressionItems.each(function(v, k) {
                var isEmpty = function(val) {
                    if (val === "") {
                        return true;
                    } else {
                        return false;
                    }
                },
                    isEndExpression = function(val) {
                        if (val === "the-end") {
                            return true;
                        } else {
                            return false;
                        }
                    },
                    sycIndex = instanceListForValueField.indexOf(v.get('text')); //syc nameFiled and valueField


                //input or tag
                if (v.one('input') === null) {
                    //tag
                    var val = v.get('text');
                    if (!isEmpty(val)) {

                        //add phase replace it with tag
                        sycIndex = instanceListForValueField.indexOf(v.get('text'));
                        if (sycIndex !== -1) {

                            //console.log(v.get('text'));
                            expresstionTemp = expresstionTemp + '($' + instanceListForNameField[sycIndex] + '$)';
                            //console.log(expresstionTemp);
                        } else if (isEndExpression(val)) {
                            //is end then push
                            expressionList.push(expresstionTemp);
                            console.log(expresstionTemp);
                            expresstionTemp = "";
                        } else {
                            //not match anything, just put text in
                            expresstionTemp = expresstionTemp + val;
                        }

                    }



                } else {
                    //input
                    var val = v.one('input').get('value');
                    if (!isEmpty(val)) {
                        //add phase
                        expresstionTemp = expresstionTemp + v.one('input').get('value');
                        //console.log(expresstionTemp);
                        //is end then push
                        if (isEndExpression(val)) {
                            expressionList.push(expresstionTemp);
                            console.log(expresstionTemp);
                            expresstionTemp = "";
                        }
                    }
                }





            });

            //////////////////
            ///write xml file
            //////////////////

            ///set onto graph
            var ontographOutput = "";
            for (var s = 0; s < ontologyGraph.length; s++) {
                ontographOutput = ontographOutput + ontologyGraph[s];
                console.log(ontographOutput);
            }

            var XML = document.createElement("div");
            var Node = document.createElement("intent");
            var Value = document.createElement("value");
            Value.innerHTML = ontographOutput;
            Node.appendChild(Value);
            var Topic = document.createElement("topic");
            Topic.innerHTML = Y.one('.app-topic').get('value');
            var Application = document.createElement("application");
            Application.innerHTML = Y.one('.app-name').get('value');
            Node.appendChild(Topic); //to be set
            Node.appendChild(Application); //to be set
            Node.appendChild(document.createElement("example")); //to be set
            var Variable = document.createElement("variables");

            for (var i = 0; i < instanceListForNameField.length; i++) {
                var item = document.createElement("item"),
                    name = document.createElement("name"),
                    source = document.createElement("source"),
                    type = document.createElement("type"),
                    value = document.createElement("value");

                name.innerHTML = instanceListForNameField[i];
                source.innerHTML = "text";
                type.innerHTML = "String";
                value.innerHTML = instanceListForValueField[i];

                item.appendChild(name);
                item.appendChild(source);
                item.appendChild(type);
                item.appendChild(value);
                Variable.appendChild(item);

            }

            Node.appendChild(Variable);

            var Regex = document.createElement("regex");

            for (var j = 0; j < expressionList.length; j++) {
                if (expressionList[j] !== "") {
                    var expression = document.createElement("expression");
                    expression.innerHTML = expressionList[j];
                    Regex.appendChild(expression);
                }

            }
            Node.appendChild(Regex);


            //            Node.appendChild(document.createElement("variables"));
            //            Node.appendChild(document.createElement("variables"));
            //            Node.appendChild(document.createElement("variables"));
            //            Node.appendChild(document.createElement("variables"));

            XML.appendChild(Node);

            //            var vv = outputXML.getElementsByTagName('variables');
            //            var item = outputXML.createElement('item');
            //            vv.appendChild(item);

            console.log(XML);
            var myXMLDoc = Y.XML.parse(XML.innerHTML);
            Y.one("#output").set('innerHTML', Y.XML.format(myXMLDoc));

            ////////////////
            ///write files
            ////////////////

            var onInitFs = function(fs) {
                //                var filename = Y.one('.app-name').get('value') + "_" + Y.one('.app-topic').get('value') + ontographOutput;
                var filename = 'test';

                fs.root.getFile('' + filename + '.xml', {
                    create: true
                }, function(fileEntry) {

                    fileEntry.createWriter(function(fileWriter) {

                        fileWriter.onwriteend = function(e) {

                            if (fileWriter.length > 0) {
                                console.log('Write completed.');

                                Y.one('.storage-list').appendChild(Y.Node.create("<div>" +
                                    "<a target='_blank' href='filesystem:http://jaydenlin.tw/persistent/" + filename + ".xml'>" + filename + " Save!</a></div>"));

                                //                                  Y.one('.storage-list').appendChild(Y.Node.create("<div>" +
                                //                                    "Save!</div>"));
                            }

                        };

                        fileWriter.onerror = function(e) {
                            console.log('Write failed: ' + e.toString());
                        };

                        fileWriter.truncate(0);
                        window.setTimeout(function() {
                            // Create a new Blob and write it to log.txt.
                            var blob = new Blob([Y.XML.format(myXMLDoc)], {
                                type: 'text/plain'
                            });

                            fileWriter.write(blob);
                        }.bind(this), 500)

                    }, errorHandler);


                }, errorHandler);



                Y.all('input').each(function(v, k) {
                    v.setAttribute('text', v.get('value'));
                });


                fs.root.getFile('' + filename + '.html', {
                    create: true
                }, function(fileEntry) {

                    fileEntry.createWriter(function(fileWriter) {

                        fileWriter.onwriteend = function(e) {

                            if (fileWriter.length > 0) {
                                console.log('Write completed.');

                                Y.one('.storage-list').appendChild(Y.Node.create("<div>" +
                                    "<a target='_blank' href='filesystem:http://jaydenlin.tw/persistent/" + filename + ".html'>" + filename + " html Save!</a></div>"));

                            }

                        };

                        fileWriter.onerror = function(e) {
                            console.log('Write failed: ' + e.toString());
                        };

                        fileWriter.truncate(0);
                        window.setTimeout(function() {

                            var dom = '<!DOCTYPE html><html><meta charset="UTF-8"/><body>' + Y.one('.ontology-graph')._node.outerHTML + Y.one('.instance-list')._node.outerHTML + Y.one('.expression-list')._node.outerHTML + '</body></html>';

                            // Create a new Blob and write it to log.txt.
                            var blob = new Blob([dom], {
                                type: 'text/plain'
                            });

                            fileWriter.write(blob);
                        }.bind(this), 500)

                    }, errorHandler);


                }, errorHandler);




            }

            navigator.webkitPersistentStorage.requestQuota(1024 * 1024, function(grantedBytes) {
                window.requestFileSystem = window.requestFileSystem || window.webkitRequestFileSystem;
                window.requestFileSystem(PERSISTENT, grantedBytes, onInitFs, errorHandler);
            }, function(e) {
                console.log('Error', e);
            });


        });


        Y.one('.importHTML').on('click', function(evt) {

            var onInitFs = function(fs) {
                var filename = 'test';
                fs.root.getFile('' + filename + '.html', {
                    create: true
                }, function(fileEntry) {

                    fileEntry.file(function(file) {
                        var reader = new FileReader();

                        reader.onloadend = function(e) {
                            var txtArea = document.createElement('textarea');
                            txtArea.value = this.result;
                            document.body.appendChild(txtArea);

                            var node = Y.Node.create(this.result),
                                entityTexts,
                                relationTexts,
                                expressionTexts,
                                ontologyGraph = Y.one('.ontology-graph'),
                                instanceList = Y.one('.instance-list'),
                                expressionList = Y.one('.expression-list');

                            //bind DnD
                            node.all('.expression-list ul').each(function(v, k) {

                                bindDDlist(v);

                            });

                            //dbl delete
                            node.all('.expression-item').each(function(v, k) {

                                bindDBLDelete(v, '.dd-list');

                            });

                            ontologyGraph.empty();
                            ontologyGraph.appendChild(node.one('.ontology-graph > legend'));
                            ontologyGraph.appendChild(node.all('.ontology-list'));
                            ontologyGraph.appendChild(node.all('.sub-ontology-list'));
                            ontologyGraph.appendChild(node.all('.sub-sub-ontology-list'));
                            instanceList.appendChild(node.all('.instance-list ul'));
                            expressionList.appendChild(node.all('.expression-list ul'));

                            entityTexts = Y.all('.entity');
                            relationTexts = Y.all('.relation');
                            expressionTexts = Y.all('.expression-text');

                            //set values
                            entityTexts.each(function(v, k) {
                                v.set('value', v.getAttribute('text'));
                                console.log(v.getAttribute('text'));
                            });

                            relationTexts.each(function(v, k) {
                                v.set('value', v.getAttribute('text'));
                                console.log(v.getAttribute('text'));
                            });

                            expressionTexts.each(function(v, k) {
                                v.set('value', v.getAttribute('text'));
                                console.log(v.getAttribute('text'));
                            });

                            //bind ontology selection
                            bindOntologySelection();

                            //bind autocomplete
                            bindAutoComplete();

                            //duplicate
                            //bindDuplicateButtons(); don't bind twice

                            //trash
                            bindTrashButtons();

                            //save entity and relation to defined
                            bindRealtimeSaveEntityAndRelation();

                        };

                        reader.readAsText(file);
                    }, errorHandler);


                }, errorHandler);


            }

            navigator.webkitPersistentStorage.requestQuota(1024 * 1024, function(grantedBytes) {
                window.requestFileSystem = window.requestFileSystem || window.webkitRequestFileSystem;
                window.requestFileSystem(PERSISTENT, grantedBytes, onInitFs, errorHandler);
            }, function(e) {
                console.log('Error', e);
            });

        })






    });
</script>

</html>

